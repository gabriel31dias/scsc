<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Viewer</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' type='text/css' media='screen' href='assets/style/viewer.css'>

    <script src="./assets/bower_components/webrtc-adapter/release/adapter.js"></script>
    <script src="./assets/bower_components/kurento-client/js/kurento-client.js"></script>
    <script src="./assets/bower_components/kurento-utils/js/kurento-utils.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #111;
            font-family: sans-serif;
            color: #fff;
        }

        #divPlayer {
            position: relative;
            width: 100%;
            height: 100vh;
            background-color: black;
        }

        #plrVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #divLoader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        #btnPlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            font-size: 60px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            cursor: pointer;
        }

        .dsh-join {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #222;
            text-align: center;
        }

        .dsh-join button {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 18px;
            background: #00bcd4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .dsh-status {
            display: none;
            padding: 10px;
            background: #333;
        }

        .dsh-online {
            border-left: 5px solid #0f0;
        }

        .dsh-active {
            background-color: #444;
        }

        .dsh-disconnected {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 10px;
            text-align: center;
            background-color: red;
            color: white;
            z-index: 1000;
        }
    </style>
</head>

<body>

    <div id="divJoin" class="dsh-join">
        <div>Presenter is not available</div>
        <button disabled>Join</button>
    </div>

    <div id="divStatus" class="dsh-status">
        <span><label>Viewer ID</label> <span id="lblViewerId">waiting</span></span>
        <span><label>Presenter status</label> <span id="lblPresenterStatus">waiting</span></span>
        <span><label>Sharing status</label> <span id="lblSharingStatus">waiting</span></span>
        <span><label>Sender ID</label> <span id="lblSenderId">waiting</span></span>
    </div>

    <div id="divPlayer">
        <div id="divLoader"><img src="./assets/image/loading.gif" /></div>
        <video id="plrVideo" autoplay playsinline muted></video>
        <button id="btnPlay">&#9658;</button>
    </div>

    <script type="module">
        import viewer from './assets/js/viewer.js';

        const events = { start: null, stop: null };
        const video = document.getElementById('plrVideo');

        const viewerObj = new viewer({
            player: video,
            iceServers: [
                {
                    urls: "turn:global.relay.metered.ca:80",
                    username: "369394507cc1094c0f286ffc",
                    credential: "tHrk+fKIBAWlrfW6",
                },
                {
                    urls: "turn:global.relay.metered.ca:443",
                    username: "369394507cc1094c0f286ffc",
                    credential: "tHrk+fKIBAWlrfW6",
                },
                {
                    urls: "turns:global.relay.metered.ca:443?transport=tcp",
                    username: "369394507cc1094c0f286ffc",
                    credential: "tHrk+fKIBAWlrfW6",
                }
            ]
        });

        if (viewerObj.autoPlay) {
            document.getElementById("divJoin").style.display = "none";
        } else {
            document.getElementById("divJoin").style.display = "flex";
        }

        viewerObj.onStatusChanged = function () {
            const joinDiv = document.getElementById("divJoin");
            const joinMsg = joinDiv.querySelector("div");
            const joinBtn = joinDiv.querySelector("button");

            document.getElementById("lblViewerId").innerText = this.socket.id;
            document.getElementById("lblSenderId").innerText = this.streamMechanism === 'streamserver' ? 'Stream Server' : (this.socket.senderId || '-');
            document.getElementById("lblPresenterStatus").innerText = this.presenterStatus;

            if (this.isConnected) {
                document.getElementById("divConnectionStatus")?.remove();
            } else {
                if (!document.getElementById("divConnectionStatus")) {
                    const errorDiv = document.createElement("div");
                    errorDiv.id = "divConnectionStatus";
                    errorDiv.className = "dsh-disconnected";
                    errorDiv.innerText = "Connection to server is lost";
                    document.body.appendChild(errorDiv);
                }
            }

            if (this.presenterStatus === 'online') {
                document.getElementById("divStatus").classList.add("dsh-online");
                if (this.isSharing) {
                    document.getElementById("lblSharingStatus").innerText = 'shared';
                    document.getElementById("divStatus").classList.add("dsh-active");

                    if (this.isWaitingViewer) {
                        joinMsg.innerText = "Sharing is available, joining...";
                        joinBtn.disabled = false;

                        // AUTO-JOIN
                        document.getElementById("divJoin").style.display = "none";
                        document.getElementById("divStatus").style.display = "block";
                        document.getElementById("divPlayer").style.display = "block";
                        this.registerViewer();

                        video.muted = false;
                        video.play().catch(err => console.warn("Autoplay failed:", err));
                        document.getElementById("btnPlay").style.display = "none";

                        events.start?.();
                    }

                } else {
                    joinMsg.innerText = "Presenter is available but not sharing";
                    joinBtn.disabled = true;
                    document.getElementById("lblSharingStatus").innerText = 'not shared';
                    document.getElementById("divStatus").classList.remove("dsh-active");
                    events.stop?.();
                }

            } else {
                document.getElementById("divLoader").style.display = "flex";
                document.getElementById("divStatus").style.display = "none";
                document.getElementById("divPlayer").style.display = "none";
                joinMsg.innerText = "Presenter is not available";
                joinBtn.disabled = true;
                document.getElementById("lblSharingStatus").innerText = 'not shared';
                document.getElementById("divStatus").classList.remove("dsh-active", "dsh-online");
                events.stop?.();
            }
        };

        // Botão JOIN (fallback manual)
        document.getElementById("divJoin").querySelector("button").addEventListener("click", () => {
            if (viewerObj.isSharing) {
                document.getElementById("divJoin").style.display = "none";
                document.getElementById("divStatus").style.display = "block";
                document.getElementById("divPlayer").style.display = "block";
                viewerObj.registerViewer();

                video.muted = false;
                video.play().catch(err => console.warn("Play error:", err));
                document.getElementById("btnPlay").style.display = "none";
            }
        });

        // Botão PLAY central
        document.getElementById("btnPlay").addEventListener("click", () => {
            video.muted = false;
            video.play().catch(err => console.warn("Play error:", err));
            document.getElementById("btnPlay").style.display = "none";
        });

        // Esconde loader quando vídeo começa
        video.addEventListener("play", () => {
            document.getElementById("divLoader").style.display = "none";
        });

        // API para eventos externos
        window.registerSharedStatus = (startEvent, stopEvent) => {
            events.start = startEvent;
            events.stop = stopEvent;
        };

        window.displaySharing = (options) => {
            if (viewerObj.isSharing) {
                viewerObj.registerViewer(options);
            }
        };
    </script>
</body>

</html>
